#
# This is the user-interface definition of a Shiny web application. You can
# run the application by clicking 'Run App' above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)
library(shinydashboard)
library(ggplot2)

# Define UI for application that draws a histogram
dashboardPage(
    skin = "green",

    # Application title
    dashboardHeader(title = "Gene Set Enrichment Analysis",
                    titleWidth = 350
                    ),

    # Sidebar with tabs for different points of the analysis
    dashboardSidebar(
        width = 350,
        sidebarMenu(
            style = "position: fixed; overflow: visible;",
            menuItem("Abstract", tabName = "abstract"),
            menuItem("MAGeCK Data", tabName = "data"),
            menuItem("Data Exploration", tabName = "exploration"),
            menuItem("GSEA Results", tabName = "gsea"), 
            menuItem("Leading Edge Subsets", tabName = "LEsubset"),
            menuItem("GSEA Output Summary", tabName = "gsea_out"),
            menuItem("Enrichment Plots", tabName = "e_plots")
        )
    ),
    
    dashboardBody(
        tabItems(
            # Abstract tab content
            tabItem(tabName = "abstract",
                    p("Gene Set Enrichment Analysis (GSEA) is an important tool 
                      for interpreting gene expression data. Rather than focusing 
                      on individual genes, GSEA studies gene sets or pathways, which 
                      are groups of genes sharing common function, location, or 
                      regulation. 
                      
                      The data used in this analysis was collected by means of a CRISPR 
                      screening process, which measures the effect of a gene by 
                      essentially deleting it and observing any difference in the 
                      resulting phenotype or outward expression for that cell. GSEA 
                      takes this expression data and ranks the genes based on the 
                      phenotypic measurements for their respective cells and observes 
                      where members of a predetermined gene set fall in that ranked list, 
                      looking for any evidence of clustering of those genes in the list. 
                      
                      Applying GSEA to the data set provides a list of significantly 
                      associated gene sets. Some of these are previously known 
                      associations, but others could provide new insight for further 
                      biological research. Identifying these opportunities for exploration 
                      is the primary goal of this analysis.", 
                      style = "font-family: 'times'; font-si16pt"
                    )
            ),
            tabItem(tabName = "data",
                    mainPanel(
                        p("The table below includes the MAGeCK gene summary
                          data set, with some cleaning, which forms the basis 
                          for analysis hereafter.", 
                          style = "font-family: 'times'; font-si16pt"
                        ),
                        DT::dataTableOutput("mageckTable")   
                    )
            ),
            tabItem(tabName = "exploration",
                    mainPanel(width = 12,
                        fluidRow(
                            box(width = 12,
                                p("The following are exploratory plots created at 
                                  the beginning of the analysis, showing the variables
                                  from the MAGeCK output.", 
                                  style = "font-family: 'times'; font-si16pt"
                                )
                            )
                        ),
                        fluidRow(
                            box(h3("Positive FDR distribution"),
                                plotOutput("pos_fdr")
                            ),
                            box(h3("Negative FDR distribution"),
                                plotOutput("neg_fdr")
                            )
                        ),
                        fluidRow(
                            box(width = 12,
                                h3("Positive vs Negative RRA scores"),
                                plotOutput("scores")
                                )
                        ),
                        fluidRow(
                            box(h3("Log fold change (LFC) distribution"),
                                plotOutput("lfc_dist")
                            ),
                            box(h3("Normality of LFC"),
                                plotOutput("lfc_norm")
                            )
                        ),
                        fluidRow(
                            # box(h3("Number of sgrnas used for target gene"),
                            #     plotOutput("sgrna")
                            #     ),
                            box(h3("Positive selection good sgrnas"),
                                plotOutput("good_pos")
                                ),
                            box(h3("Negative selection good sgrnas"),
                                plotOutput("good_neg")
                            )
                        ),
                        fluidRow(
                            box(width = 12,
                                h3("Correlation plot of numeric variables"),
                                plotOutput("corr")
                                )
                        )
                    )
                    ),
            tabItem(tabName = "gsea",
                    mainPanel(
                        p("The following data set represents the output 
                          when GSEA is applied to the MAGeCK data,
                          pre-ranked using log fold change. We used 1000 permutations
                          and a step weight of 1. ", 
                          style = "font-family: 'times'; font-si16pt"
                        ),
                        DT::dataTableOutput("distTable")
                    )
            ),
            tabItem(tabName = "LEsubset",
                    mainPanel(
                        p("The table below includes the leading edge subset
                          for each pathway, along with the size of the gene set 
                          and size of the subset.", 
                          style = "font-family: 'times'; font-si16pt"
                        ),
                        DT::dataTableOutput("leadingTable")
                    )
            ),
            tabItem(tabName = "gsea_out",
                    fluidRow(
                        box(width = 12,
                            sliderInput(
                                "padj",
                                "FDR cutoff",
                                min = 0,
                                max = 1,
                                value = 1
                                )
                            )
                    ),
                    fluidRow(
                        box(width = 12,
                            h3("Size of gene set vs. size of Leading edge subset"),
                            plotly::plotlyOutput("le_gene")
                        )
                    ),
                    fluidRow(
                        box(width = 12,
                            h3("ES and NES distributions"),
                            plotOutput("es_dist")
                        )
                    ),
                    fluidRow(
                        box(width = 12,
                            h3("FDR and gene set size"),
                            plotly::plotlyOutput("fdr_size")
                        )
                    )
            ),
            tabItem(tabName = "e_plots",
                    fluidRow(
                        #column(width = 12,
                        box(
                            selectInput("set",
                                        h3("Gene set of interest: "),
                                        c(Choose='', score_df$pathway),
                                        selectize = TRUE                             
                                        )
                        ),
                        box(h4("Results: "),
                            tableOutput("enrichData")
                        )
                    ),
                    fluidRow(
                        box(width = 12,
                            plotOutput("enrichPlot")
                        )
                    )
                    
            )
        ),
        tags$head(tags$style(HTML('.content-wrapper { overflow: auto; }')))
    )
        
)

